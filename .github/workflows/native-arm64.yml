name: Native Image Build (ARM64)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., 1.0.0)'
        required: false
        default: 'snapshot'
      create_release:
        description: 'Create GitHub release'
        required: false
        type: boolean
        default: false

jobs:
  native-arm64:
    name: Build native binary on ARM64
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up GraalVM Java 25
        uses: actions/setup-java@v4
        with:
          distribution: graalvm
          java-version: '25'
          cache: maven
          check-latest: true

      - name: Build native image
        run: |
          mvn --batch-mode -Pnative -DskipTests \
            native:compile-no-fork \
            -Dnative.image-name=trafik-websocket-server-linux-arm64

      - name: Verify binary
        run: |
          file target/trafik-websocket-server-linux-arm64
          ls -lh target/trafik-websocket-server-linux-arm64

      - name: Upload native binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: trafik-websocket-server-arm64
          path: target/trafik-websocket-server-linux-arm64
          retention-days: 30

      - name: Create GitHub release
        if: ${{ inputs.create_release }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: Release ${{ inputs.version }}
          files: target/trafik-websocket-server-linux-arm64
          generate_release_notes: true

      - name: Job summary
        if: always()
        run: |
          echo "## Native Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | linux-arm64 |" >> $GITHUB_STEP_SUMMARY
          echo "| Java Version | GraalVM 25 |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ inputs.version }} |" >> $GITHUB_STEP_SUMMARY
          if [ -f target/trafik-websocket-server-linux-arm64 ]; then
            echo "| Binary Size | $(du -h target/trafik-websocket-server-linux-arm64 | cut -f1) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Binary Size | n/a |" >> $GITHUB_STEP_SUMMARY
          fi
