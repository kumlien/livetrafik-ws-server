name: Deploy to Raspberry Pi

on:
  workflow_dispatch:
    inputs:
      restart_service:
        description: 'Restart systemd service after deploy'
        type: boolean
        required: false
        default: true

jobs:
  deploy:
    name: Deploy native binary to Raspberry Pi
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Download latest native binary artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: native-arm64.yml          # ändra till rätt build-workflowfil
          workflow_conclusion: success
          name: trafik-websocket-server-arm64

      - name: Verify downloaded binary
        run: |
          ls -lh
          file trafik-websocket-server-linux-arm64

      - name: Install cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Cloudflare Access login (manual)
        run: |
          cloudflared access login https://trafik-ssh.svante-for-the.win
          echo ""
          echo "Öppna URL:en ovan i din webbläsare, logga in via Cloudflare Access."
          echo "När sidan bekräftar att du är inloggad fortsätter workflowet."


      - name: Configure SSH client
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PI_SSH_KEY }}" > ~/.ssh/id_ed25519_pi
          chmod 600 ~/.ssh/id_ed25519_pi

          cat <<'EOF' >> ~/.ssh/config
          Host trafik-pi
            HostName trafik-ssh.svante-for-the.win
            User admin
            IdentityFile ~/.ssh/id_ed25519_pi
            IdentitiesOnly yes
            ProxyCommand cloudflared access ssh --hostname %h
          EOF

      - name: Add Raspberry Pi host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H trafik-ssh.svante-for-the.win >> ~/.ssh/known_hosts


      - name: Copy binary to /opt/livetrafik on Raspberry Pi
        run: |
          scp trafik-websocket-server-linux-arm64 trafik-pi:/home/admin/trafik-websocket-server-linux-arm64

          ssh trafik-pi <<'EOSSH'
          sudo mv /home/admin/trafik-websocket-server-linux-arm64 /opt/livetrafik/trafik-websocket-server-linux-arm64
          sudo chown root:root /opt/livetrafik/trafik-websocket-server-linux-arm64
          sudo chmod 755 /opt/livetrafik/trafik-websocket-server-linux-arm64
          EOSSH
      
      - name: Restart livetrafik-ws.service on Raspberry Pi
        if: ${{ inputs.restart_service }}
        run: |
          ssh trafik-pi "sudo systemctl restart livetrafik-ws.service && sudo systemctl status livetrafik-ws.service --no-pager -n 20"

